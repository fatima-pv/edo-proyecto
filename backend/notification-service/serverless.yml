service: edo-notification-service

provider:
  name: aws
  runtime: python3.9
  region: us-east-1
  memorySize: 256
  timeout: 29
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource: !GetAtt NotificationQueue.Arn
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: !Ref OrderNotificationTopic
  environment:
    NOTIFICATION_QUEUE_URL: !Ref NotificationQueue
    SNS_TOPIC_ARN: !Ref OrderNotificationTopic
    ORDERS_TABLE: EdoOrdersTable

functions:
  # Procesa mensajes de SQS y envía emails por SNS
  processNotification:
    handler: handler.process_notification
    events:
      - sqs:
          arn: !GetAtt NotificationQueue.Arn
          batchSize: 10

  # Endpoint para enviar notificación manual (opcional)
  sendNotification:
    handler: handler.send_notification_manual
    events:
      - http:
          path: notifications/send
          method: post
          cors: true

resources:
  Resources:
    # SNS Topic para notificaciones
    OrderNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: EdoOrderNotifications
        DisplayName: Edo Sushi Order Notifications
        
    # SQS Queue para procesar notificaciones
    NotificationQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: EdoNotificationQueue
        VisibilityTimeout: 300
        MessageRetentionPeriod: 86400
        ReceiveMessageWaitTimeSeconds: 20
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt NotificationDLQ.Arn
          maxReceiveCount: 3
    
    # Dead Letter Queue para mensajes fallidos
    NotificationDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: EdoNotificationDLQ
        MessageRetentionPeriod: 1209600  # 14 días
    
    # Política para que SNS pueda escribir en SQS
    QueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref NotificationQueue
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: sns.amazonaws.com
              Action: SQS:SendMessage
              Resource: !GetAtt NotificationQueue.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !Ref OrderNotificationTopic
    
    # Suscripción: SNS -> SQS
    QueueSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: !Ref OrderNotificationTopic
        Endpoint: !GetAtt NotificationQueue.Arn
        RawMessageDelivery: true

outputs:
  SNSTopicArn:
    Description: ARN del SNS Topic
    Value: !Ref OrderNotificationTopic
    Export:
      Name: EdoOrderNotificationTopicArn
  
  SQSQueueUrl:
    Description: URL de la cola SQS
    Value: !Ref NotificationQueue
    Export:
      Name: EdoNotificationQueueUrl
